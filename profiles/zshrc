# ============================================================================
# Oh My Zsh Configuration
# ============================================================================

# Path to your oh-my-zsh installation.
export ZSH=/Users/$(whoami)/.oh-my-zsh

# Theme configuration
ZSH_THEME="robbyrussell"

# Completion settings
CASE_SENSITIVE="true"
HYPHEN_INSENSITIVE="true"

# Terminal behavior
DISABLE_AUTO_TITLE="true"
HIST_STAMPS="yyyy-mm-dd"

# Plugin configuration
plugins=(git docker macos brew node npm python history)
# Add zsh-completions if it exists (it's a custom plugin, not always installed)
if [[ -d "${ZSH_CUSTOM:-${ZSH}/custom}/plugins/zsh-completions" ]]; then
    plugins+=(zsh-completions)
fi

# ============================================================================
# Environment Variables
# ============================================================================

# Application-specific environment variables
export DEFAULT_CONDA_ENV=py3
export ZSH_DISABLE_COMPFIX=true
export LANG=en_US.UTF-8

# Unset variables that interfere with applications
unset SSL_CERT_FILE

# Build tool paths
export M2_HOME=/usr/local/Cellar/maven/3.6.0/libexec
export M2=${M2_HOME}/bin

# Compilation flags
export LDFLAGS="-L/usr/local/opt/libffi/lib -L/usr/local/opt/gettext/lib"
export CPPFLAGS="-I/usr/local/opt/gettext/include"

# Python virtual environment
export VIRTUALENVWRAPPER_PYTHON=$(brew --prefix python)/bin/python3

# ============================================================================
# Oh My Zsh Initialization
# ============================================================================

source ${ZSH}/oh-my-zsh.sh

# ============================================================================
# Workspace Loader
# ============================================================================
# The following assumes that ~/.zshrc is a symbolic link to the environment dir ...
# This needs to run after oh my zsh since it messes with ps1

ZSHRC_LINK=$(readlink ${HOME}/.zshrc 2>/dev/null)
if [ -n "${ZSHRC_LINK}" ]; then
    LOADER_PATH=$(dirname $(dirname ${HOME}/${ZSHRC_LINK}))/loader.sh
    if [ -f "${LOADER_PATH}" ]; then
        source "${LOADER_PATH}" 2>&1
    fi
fi

# ============================================================================
# ZSH Plugins & Extensions
# ============================================================================

# Antigen plugin manager
if test -f "${HOME}/.oh-my-zsh/plugins/antigen/antigen.zsh" ; then
  source ${HOME}/.oh-my-zsh/plugins/antigen/antigen.zsh
  # Load antigen plugins ... order important!
  # https://github.com/unixorn/awesome-zsh-plugins/blob/master/README.md#installation
  antigen bundle Tarrasch/zsh-autoenv
  # https://github.com/zsh-users/zsh-syntax-highlighting/blob/master/INSTALL.md
  antigen bundle zsh-users/zsh-syntax-highlighting
  # antigen bundle softmoth/zsh-vim-mode
  # antigen bundle mafredri/zsh-async
  # https://github.com/sindresorhus/pure
  # antigen bundle sindresorhus/pure
  antigen apply
fi

# Auto Jump - intelligent directory jumping
[[ -s $(brew --prefix)/etc/profile.d/autojump.sh ]] && . $(brew --prefix)/etc/profile.d/autojump.sh

# ============================================================================
# Career Workspace (Optional)
# ============================================================================

# _loader_msg_simple is defined in common.sh (loaded via loader.sh above)
# No fallback needed - common.sh is guaranteed to be loaded by this point

ZSENV_LINK=$(readlink ${HOME}/.zshenv 2>/dev/null)
if [ -n "${ZSENV_LINK}" ]; then
    CAREER_WORKSPACE_DIR=$(dirname $(dirname ${HOME}/${ZSENV_LINK}))/../workspace-career
    if [[ -d "${CAREER_WORKSPACE_DIR}" ]]; then
        _loader_msg_simple "ðŸ’¼" "Loading career workspace" "start"
        [[ -f ${CAREER_WORKSPACE_DIR}/functions.sh ]] && source ${CAREER_WORKSPACE_DIR}/functions.sh 2>/dev/null
        [[ -f ${CAREER_WORKSPACE_DIR}/aliases.sh ]] && source ${CAREER_WORKSPACE_DIR}/aliases.sh 2>/dev/null
        _loader_msg_simple "ðŸ’¼" "Career workspace" "done"
    fi
fi

# ============================================================================
# Terminal Integration
# ============================================================================

# iTerm2 shell integration
ITERM_INTEGRATION=$(which iterm2_shell_integration.zsh)
if test -f "${ITERM_INTEGRATION}" ; then
  source "${ITERM_INTEGRATION}"
fi

# ============================================================================
# Completion System
# ============================================================================
# https://github.com/zsh-users/zsh-completions/issues/277#issuecomment-414139674

fpath=(${DIRS_ENVIRONMENT}/functions-completion/zsh $fpath)
if test -f "${CAREER_WORKSPACE_DIR}/" ; then 
  fpath=(${DIRS_ENVIRONMENT}/../workspace-career/completion-functions/zsh $fpath)
fi
rm -f "$HOME/.zcompdump"
autoload -U compinit
# https://stackoverflow.com/questions/13762280/zsh-compinit-insecure-directories
compinit -u

# Additional completion configuration
autoload -Uz compinit
zstyle ':completion:*' menu select
fpath+=~/.zfunc

# ============================================================================
# Version Managers
# ============================================================================

# ASDF version manager
if [[ -d $HOME/.asdf/ ]] ; then 
	. $HOME/.asdf/asdf.sh
	. $HOME/.asdf/completions/asdf.bash
fi

# ============================================================================
# Keybindings & Editor Mode
# ============================================================================

bindkey -v
# https://stackoverflow.com/questions/58187542/how-to-setup-vi-editing-mode-for-zsh#:~:text=bindkey%20%2Dv%20is%20enough%20to,%22insert%22%20mode%20by%20default.

# To fix control a and e
# https://superuser.com/questions/523564/emacs-keybindings-in-zsh-not-working-ctrl-a-ctrl-e
bindkey -e

# ============================================================================
# Shared Workspace Loader
# ============================================================================

SHARED_LOADER=$(first "${DIRS_ENVIRONMENT}/loader-shared.sh" "$(brew --prefix sharedspace)/loader-shared.sh" 2>/dev/null)
if [ -n "${SHARED_LOADER}" ] && [ -f "${SHARED_LOADER}" ]; then
    [[ "${DEBUG_LOADER:-false}" == "true" ]] && echo "Using Loader: ${SHARED_LOADER}" >&2
    source "${SHARED_LOADER}" #tag:inject-sharedspace-loader
fi

# ============================================================================
# Python & Node Environment Setup
# ============================================================================
# Performance Optimization: Deferred loading of heavy environments
# https://code.visualstudio.com/docs/supporting/faq#_installation-appears-to-be-corrupt-unsupported

function continue-loading-profile() {

  # Activate Virtual Envs

  # >>> conda initialize >>>
  # !! Contents within this block are managed by 'conda init' !!
  __conda_setup="$('${DIR_CONDA_HOME}/bin/conda' 'shell.zsh' 'hook' 2> /dev/null)"
  if [ $? -eq 0 ]; then
      eval "$__conda_setup"
  else
      if [ -f "${DIR_CONDA_HOME}/etc/profile.d/conda.sh" ]; then
	. "${DIR_CONDA_HOME}/etc/profile.d/conda.sh"  # commented out by conda initialize
      else
	# export PATH="${DIR_CONDA_HOME}/bin:$PATH"  # commented out by conda initialize
      fi
  fi
  unset __conda_setup
  # <<< conda initialize <<<
  
  # Install env if not existing
  _loader_msg_simple "ðŸ" "Initializing Conda" "start"
  (conda env list --json 2>/dev/null | jq -r '.envs | map(select(contains("/envs/"))) | .[]' 2>/dev/null | xargs basename 2>/dev/null | grep -q ${DEFAULT_CONDA_ENV} 2>/dev/null) || conda create -n ${DEFAULT_CONDA_ENV} -y python=3 pip >/dev/null 2>&1
  conda activate ${DEFAULT_CONDA_ENV} >/dev/null 2>&1
  _loader_msg_simple "ðŸ" "Conda env [${DEFAULT_CONDA_ENV}]" "done"

  # NVM (Node Version Manager)
  _loader_msg_simple "ðŸ“¦" "Initializing NVM" "start"
  if ( brew list nvm 2>/dev/null ); then
      # https://github.com/nvm-sh/nvm/issues/860
      # source $(brew --prefix nvm)/nvm.sh
      source $(brew --prefix)/opt/nvm/nvm.sh 2>/dev/null # using this instead of the above for performance ...
  else 
	if ( test -d "$HOME/.nvm" );
	export NVM_DIR="$HOME/.nvm"
	[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" 2>/dev/null # This loads nvm
  fi

  [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion" 2>/dev/null # This loads nvm bash_completion
  nvm list ${DEFAULT_NVM_ENV} 1>/dev/null 2>/dev/null || nvm install ${DEFAULT_NVM_ENV} >/dev/null 2>&1
  nvm use ${DEFAULT_NVM_ENV} >/dev/null 2>&1
  _loader_msg_simple "ðŸ“¦" "Node $(nvm current 2>/dev/null || echo 'N/A')" "done"

  # Setup AI dependencies
  if command -v npm >/dev/null 2>&1; then
    _loader_msg_simple "ðŸ¤–" "Setting up AI dependencies" "start"
    # Check and install @google/gemini-cli
    if ! npm list -g @google/gemini-cli >/dev/null 2>&1; then
      npm install -g @google/gemini-cli >/dev/null 2>&1
    fi
    # Check and install @anthropic-ai/claude-code
    if ! npm list -g @anthropic-ai/claude-code >/dev/null 2>&1; then
      npm install -g @anthropic-ai/claude-code >/dev/null 2>&1
    fi
    # Check and install @musistudio/claude-code-router
    if ! npm list -g @musistudio/claude-code-router >/dev/null 2>&1; then
      npm install -g @musistudio/claude-code-router >/dev/null 2>&1
    fi
    _loader_msg_simple "ðŸ¤–" "AI dependencies" "done"
  fi

}

continue-loading-profile

# ============================================================================
# Application-Specific Setup
# ============================================================================

# LM Studio CLI
export PATH="$PATH:/Users/omareid/.lmstudio/bin"

# Docker CLI completions
fpath=(/Users/omareid/.docker/completions $fpath)
autoload -Uz compinit
compinit

# ============================================================================
# Commented Out / Future Configuration
# ============================================================================

# set -x  # Debug mode
# set -o vi  # Vi editing mode
# source $(brew --prefix autoenv)/activate.sh
# https://direnv.net/
# eval "$(direnv hook zsh)"
# Getting all the nix stuff loaded!
# . /Users/$(whoami)/.nix-profile/etc/profile.d/nix.sh
